<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .kanban-column {
            min-height: 500px;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .filter-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .filter-badge .close {
            cursor: pointer;
            margin-left: 6px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="p-6">
        <!-- HEADER -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Kanban de Compras</h1>
                <p class="text-gray-600 mt-2">Gerenciamento de pedidos e cota√ß√µes</p>
            </div>
            <div class="flex gap-2">
                <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </header>

        <!-- FILTROS -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">üîç Filtros & Busca</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- BUSCA -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Buscar (OC ou Item)</label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Digite n√∫mero OC ou nome do item..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onkeyup="applyFilters()"
                    >
                </div>

                <!-- FORNECEDOR -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fornecedor</label>
                    <select 
                        id="fornecedorFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="applyFilters()"
                    >
                        <option value="">Todos os fornecedores</option>
                    </select>
                </div>

                <!-- STATUS -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select 
                        id="statusFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="applyFilters()"
                    >
                        <option value="">Todos os status</option>
                        <option value="Cota√ß√£o">Cota√ß√£o</option>
                        <option value="Ordem de Compra Emitida">OC Emitida</option>
                        <option value="Em Tr√¢nsito">Em Tr√¢nsito</option>
                        <option value="Recebido">Recebido</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>

                <!-- DATA -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Per√≠odo</label>
                    <select 
                        id="dataFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="applyFilters()"
                    >
                        <option value="">Todos os per√≠odos</option>
                        <option value="7">√öltimos 7 dias</option>
                        <option value="30">√öltimos 30 dias</option>
                        <option value="90">√öltimos 90 dias</option>
                    </select>
                </div>
            </div>

            <!-- FILTROS ATIVOS -->
            <div id="activeFilters" class="mb-4"></div>

            <!-- BOT√ÉO LIMPAR -->
            <button 
                onclick="clearFilters()" 
                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
            >
                üßπ Limpar Filtros
            </button>

            <!-- CONTADOR -->
            <div class="mt-4 text-sm text-gray-600">
                Exibindo <span id="filteredCount">0</span> de <span id="totalCount">0</span> registros
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden flex justify-center items-center h-64">
            <div class="loading-spinner"></div>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Erro!</strong>
            <span class="block sm:inline" id="error-message"></span>
        </div>

        <!-- Kanban Board -->
        <div id="board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 overflow-x-auto">
            
            <!-- Coluna: Cota√ß√£o -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        Cota√ß√£o
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-cotacao">0</span>
                </div>
                <div id="col-cotacao" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Ordem de Compra Emitida -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        OC Emitida
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-oc">0</span>
                </div>
                <div id="col-oc" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Em Tr√¢nsito -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                        Em Tr√¢nsito
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-transito">0</span>
                </div>
                <div id="col-transito" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Recebido -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        Recebido
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-recebido">0</span>
                </div>
                <div id="col-recebido" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Cancelado -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        Cancelado
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-cancelado">0</span>
                </div>
                <div id="col-cancelado" class="kanban-column space-y-3"></div>
            </div>

        </div>
    </div>

    <script>
        // ===== VARI√ÅVEIS GLOBAIS =====
        let allRecords = []; // Armazena todos os registros
        let filteredRecords = []; // Armazena registros filtrados

        // Mapeamento dos Status
        const statusMap = {
            'Cota√ß√£o': 'col-cotacao',
            'Ordem de Compra Emitida': 'col-oc',
            'Em Tr√¢nsito': 'col-transito',
            'Recebido': 'col-recebido',
            'Cancelado': 'col-cancelado'
        };

        const countMap = {
            'Cota√ß√£o': 'count-cotacao',
            'Ordem de Compra Emitida': 'count-oc',
            'Em Tr√¢nsito': 'count-transito',
            'Recebido': 'count-recebido',
            'Cancelado': 'count-cancelado'
        };

        // ===== FUN√á√ïES AUXILIARES =====
        const formatCurrency = (value) => {
            if (!value) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        };

        const getDaysOld = (dateString) => {
            if (!dateString) return 999;
            const date = new Date(dateString);
            const today = new Date();
            const diffTime = Math.abs(today - date);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        // ===== FETCH DADOS =====
        async function fetchData() {
            const loading = document.getElementById('loading');
            const board = document.getElementById('board');
            const errorDiv = document.getElementById('error');
            const errorMsg = document.getElementById('error-message');

            loading.classList.remove('hidden');
            board.classList.add('opacity-50');
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/proxy');
                if (!response.ok) throw new Error('Falha ao carregar dados');
                
                const data = await response.json();
                allRecords = data.records || [];
                
                // Populate dropdown de fornecedores
                populateFornecedorDropdown();
                
                // Aplicar filtros (que vai renderizar com filtros vazios = tudo)
                applyFilters();

            } catch (error) {
                console.error(error);
                errorMsg.textContent = 'Erro ao conectar com o servidor. Tente novamente.';
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                board.classList.remove('opacity-50');
            }
        }

        // ===== POPULATE FORNECEDORES =====
        function populateFornecedorDropdown() {
            const fornecedores = new Set();
            allRecords.forEach(record => {
                const f = record.fields['Fornecedor'];
                if (f) fornecedores.add(f);
            });

            const select = document.getElementById('fornecedorFilter');
            // Limpar op√ß√µes antigas (mant√©m a primeira)
            while (select.options.length > 1) {
                select.remove(1);
            }

            // Adicionar fornecedores
            Array.from(fornecedores).sort().forEach(fornecedor => {
                const option = document.createElement('option');
                option.value = fornecedor;
                option.textContent = fornecedor;
                select.appendChild(option);
            });
        }

        // ===== APLICAR FILTROS =====
        function applyFilters() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const fornecedorValue = document.getElementById('fornecedorFilter').value;
            const statusValue = document.getElementById('statusFilter').value;
            const dataValue = document.getElementById('dataFilter').value;

            // Filtrar registros
            filteredRecords = allRecords.filter(record => {
                const f = record.fields;
                
                // BUSCA
                if (searchValue) {
                    const oc = String(f['N√∫mero OC'] || '').toLowerCase();
                    const item = String(f['Item'] || '').toLowerCase();
                    if (!oc.includes(searchValue) && !item.includes(searchValue)) {
                        return false;
                    }
                }

                // FORNECEDOR
                if (fornecedorValue && f['Fornecedor'] !== fornecedorValue) {
                    return false;
                }

                // STATUS
                if (statusValue && f['Select'] !== statusValue) {
                    return false;
                }

                // DATA
                if (dataValue) {
                    const daysOld = getDaysOld(f['Data de Cria√ß√£o']);
                    if (daysOld > parseInt(dataValue)) {
                        return false;
                    }
                }

                return true;
            });

            // Renderizar kanban com registros filtrados
            renderKanban(filteredRecords);

            // Mostrar filtros ativos
            updateActiveFilters();

            // Atualizar contadores
            document.getElementById('filteredCount').textContent = filteredRecords.length;
            document.getElementById('totalCount').textContent = allRecords.length;
        }

        // ===== RENDERIZAR KANBAN =====
        function renderKanban(records) {
            // Limpar colunas
            Object.values(statusMap).forEach(colId => {
                document.getElementById(colId).innerHTML = '';
            });

            // Resetar contadores
            Object.values(countMap).forEach(countId => {
                document.getElementById(countId).textContent = '0';
            });

            // Contadores tempor√°rios
            const counts = {
                'Cota√ß√£o': 0,
                'Ordem de Compra Emitida': 0,
                'Em Tr√¢nsito': 0,
                'Recebido': 0,
                'Cancelado': 0
            };

            // Renderizar cards
            records.forEach(record => {
                const f = record.fields;
                const status = f['Select'] || 'Cota√ß√£o';
                const colId = statusMap[status];

                if (colId) {
                    counts[status]++;
                    const card = createCard(f, record.id);
                    document.getElementById(colId).insertAdjacentHTML('beforeend', card);
                }
            });

            // Atualizar contadores
            Object.keys(counts).forEach(key => {
                if (countMap[key]) {
                    document.getElementById(countMap[key]).textContent = counts[key];
                }
            });
        }

        // ===== CRIAR CARD =====
        function createCard(fields, recordId) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 card-hover transition-all duration-200 cursor-pointer">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">OC-${fields['N√∫mero OC'] || 'N/A'}</span>
                        <span class="text-xs text-gray-400"><i class="far fa-calendar-alt mr-1"></i>${formatDate(fields['Data de Cria√ß√£o'] || '')}</span>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 text-sm mb-1 line-clamp-2">${fields['Item'] || 'Sem t√≠tulo'}</h3>
                    <p class="text-xs text-gray-500 mb-3 flex items-center">
                        <i class="fas fa-store mr-1"></i> ${fields['Fornecedor'] || 'Fornecedor n/a'}
                    </p>
                    
                    <div class="border-t border-gray-100 pt-3 flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            Qtd: <span class="font-medium text-gray-700">${fields['Quantidade'] || 0}</span>
                        </div>
                        <div class="text-sm font-bold text-green-600">
                            ${formatCurrency(fields['Valor Total'])}
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== ATUALIZAR FILTROS ATIVOS =====
        function updateActiveFilters() {
            const filters = [];
            const search = document.getElementById('searchInput').value;
            const fornecedor = document.getElementById('fornecedorFilter').value;
            const status = document.getElementById('statusFilter').value;
            const data = document.getElementById('dataFilter').value;

            if (search) filters.push(`Busca: "${search}"`);
            if (fornecedor) filters.push(`Fornecedor: ${fornecedor}`);
            if (status) filters.push(`Status: ${status}`);
            if (data) filters.push(`Per√≠odo: √öltimos ${data} dias`);

            const container = document.getElementById('activeFilters');
            if (filters.length > 0) {
                container.innerHTML = '<div><strong>Filtros ativos:</strong> ' + filters.join(' | ') + '</div>';
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // ===== LIMPAR FILTROS =====
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('fornecedorFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dataFilter').value = '';
            applyFilters();
        }

        // ===== EXPORT CSV (CORRIGIDO) =====
        function exportToCSV() {
            if (filteredRecords.length === 0) {
                alert('Nenhum registro para exportar');
                return;
            }

            // Preparar dados
            const data = filteredRecords.map(record => {
                const f = record.fields;
                return {
                    'N√∫mero OC': f['N√∫mero OC'] || '',
                    'Item': f['Item'] || '',
                    'Fornecedor': f['Fornecedor'] || '',
                    'Status': f['Select'] || '',
                    'Quantidade': f['Quantidade'] || 0,
                    'Valor Total': formatCurrency(f['Valor Total'] || 0),
                    'Data de Cria√ß√£o': formatDate(f['Data de Cria√ß√£o'] || ''),
                    'Data de Entrega': formatDate(f['Data de Entrega Esperada'] || '')
                };
            });

            // Gerar CSV
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Escapar aspas e valores com v√≠rgula
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');

            // Criar blob e download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `kanban-compras-${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ===== CARREGAR DADOS AO INICIAR =====
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
