<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .kanban-column {
            min-height: 500px;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-sm w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-lock text-blue-600 text-4xl mb-3"></i>
                <h2 class="text-2xl font-bold text-gray-800">Kanban de Compras</h2>
                <p class="text-gray-600 mt-2">Fa칞a login para continuar</p>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        placeholder="seu@email.com"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                    >
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
                >
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            
            <div id="loginError" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded text-sm"></div>
        </div>
    </div>

    <!-- APP CONTENT (HIDDEN UNTIL LOGIN) -->
    <div id="appContent" class="hidden p-6">
        <!-- HEADER -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Kanban de Compras</h1>
                <p class="text-gray-600 mt-2">Gerenciamento de pedidos e cota칞칫es</p>
            </div>
            <div class="flex gap-2 items-center">
                <div class="text-right">
                    <p class="text-sm text-gray-600">Logado como:</p>
                    <p class="font-semibold text-gray-800" id="userEmail">-</p>
                </div>
                <div class="border-l border-gray-300 h-8"></div>
                <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button onclick="exportToXLSX()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-download"></i> Exportar Excel
                </button>
                <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- FILTROS -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">游댌 Filtros & Busca</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- BUSCA -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Buscar (OC ou Item)</label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Digite n칰mero OC ou nome do item..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onkeyup="applyFilters()"
                    >
                </div>

                <!-- FORNECEDOR -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fornecedor</label>
                    <select 
                        id="fornecedorFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="applyFilters()"
                    >
                        <option value="">Todos os fornecedores</option>
                    </select>
                </div>

                <!-- STATUS -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select 
                        id="statusFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="applyFilters()"
                    >
                        <option value="">Todos os status</option>
                        <option value="Cota칞칚o">Cota칞칚o</option>
                        <option value="Ordem de Compra Emitida">OC Emitida</option>
                        <option value="Em Tr칙nsito">Em Tr칙nsito</option>
                        <option value="Recebido">Recebido</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>

                <!-- DATA -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Per칤odo</label>
                    <select 
                        id="dataFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                        onchange="applyFilters()"
                    >
                        <option value="">Todos os per칤odos</option>
                        <option value="7">칔ltimos 7 dias</option>
                        <option value="30">칔ltimos 30 dias</option>
                        <option value="90">칔ltimos 90 dias</option>
                    </select>
                </div>
            </div>

            <!-- FILTROS ATIVOS -->
            <div id="activeFilters" class="mb-4"></div>

            <!-- BOT츾O LIMPAR -->
            <button 
                onclick="clearFilters()" 
                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
            >
                游빛 Limpar Filtros
            </button>

            <!-- CONTADOR -->
            <div class="mt-4 text-sm text-gray-600">
                Exibindo <span id="filteredCount">0</span> de <span id="totalCount">0</span> registros
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden flex justify-center items-center h-64">
            <div class="loading-spinner"></div>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Erro!</strong>
            <span class="block sm:inline" id="error-message"></span>
        </div>

        <!-- Kanban Board -->
        <div id="board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 overflow-x-auto">
            
            <!-- Coluna: Cota칞칚o -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        Cota칞칚o
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-cotacao">0</span>
                </div>
                <div id="col-cotacao" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Ordem de Compra Emitida -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        OC Emitida
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-oc">0</span>
                </div>
                <div id="col-oc" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Em Tr칙nsito -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                        Em Tr칙nsito
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-transito">0</span>
                </div>
                <div id="col-transito" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Recebido -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        Recebido
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-recebido">0</span>
                </div>
                <div id="col-recebido" class="kanban-column space-y-3"></div>
            </div>

            <!-- Coluna: Cancelado -->
            <div class="bg-gray-200 p-4 rounded-xl min-w-[280px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        Cancelado
                    </h2>
                    <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-sm font-semibold count-tag" id="count-cancelado">0</span>
                </div>
                <div id="col-cancelado" class="kanban-column space-y-3"></div>
            </div>

        </div>
    </div>
    </div>

    <!-- Tabela oculta para exporta칞칚o -->
    <table id="exportTable" style="display: none;"></table>

    <script>
        // ===== VARI츼VEIS GLOBAIS =====
        let allRecords = [];
        let filteredRecords = [];
        let currentUser = null;

        const statusMap = {
            'Cota칞칚o': 'col-cotacao',
            'Ordem de Compra Emitida': 'col-oc',
            'Em Tr칙nsito': 'col-transito',
            'Recebido': 'col-recebido',
            'Cancelado': 'col-cancelado'
        };

        const countMap = {
            'Cota칞칚o': 'count-cotacao',
            'Ordem de Compra Emitida': 'count-oc',
            'Em Tr칙nsito': 'count-transito',
            'Recebido': 'count-recebido',
            'Cancelado': 'count-cancelado'
        };

        // ===== FUN칂칏ES AUXILIARES =====
        const formatCurrency = (value) => {
            if (!value) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        };

        const getDaysOld = (dateString) => {
            if (!dateString) return 999;
            const date = new Date(dateString);
            const today = new Date();
            const diffTime = Math.abs(today - date);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        // ===== FETCH DADOS =====
        async function fetchData() {
            const loading = document.getElementById('loading');
            const board = document.getElementById('board');
            const errorDiv = document.getElementById('error');
            const errorMsg = document.getElementById('error-message');

            loading.classList.remove('hidden');
            board.classList.add('opacity-50');
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/proxy');
                if (!response.ok) throw new Error('Falha ao carregar dados');
                
                const data = await response.json();
                allRecords = data.records || [];
                
                populateFornecedorDropdown();
                applyFilters();

            } catch (error) {
                console.error(error);
                errorMsg.textContent = 'Erro ao conectar com o servidor. Tente novamente.';
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                board.classList.remove('opacity-50');
            }
        }

        // ===== POPULATE FORNECEDORES =====
        function populateFornecedorDropdown() {
            const fornecedores = new Set();
            allRecords.forEach(record => {
                const f = record.fields['Fornecedor'];
                if (f) fornecedores.add(f);
            });

            const select = document.getElementById('fornecedorFilter');
            while (select.options.length > 1) {
                select.remove(1);
            }

            Array.from(fornecedores).sort().forEach(fornecedor => {
                const option = document.createElement('option');
                option.value = fornecedor;
                option.textContent = fornecedor;
                select.appendChild(option);
            });
        }

        // ===== APLICAR FILTROS =====
        function applyFilters() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const fornecedorValue = document.getElementById('fornecedorFilter').value;
            const statusValue = document.getElementById('statusFilter').value;
            const dataValue = document.getElementById('dataFilter').value;

            filteredRecords = allRecords.filter(record => {
                const f = record.fields;
                
                if (searchValue) {
                    const oc = String(f['N칰mero OC'] || '').toLowerCase();
                    const item = String(f['Item'] || '').toLowerCase();
                    if (!oc.includes(searchValue) && !item.includes(searchValue)) {
                        return false;
                    }
                }

                if (fornecedorValue && f['Fornecedor'] !== fornecedorValue) {
                    return false;
                }

                if (statusValue && f['Select'] !== statusValue) {
                    return false;
                }

                if (dataValue) {
                    const daysOld = getDaysOld(f['Data de Cria칞칚o']);
                    if (daysOld > parseInt(dataValue)) {
                        return false;
                    }
                }

                return true;
            });

            renderKanban(filteredRecords);
            updateActiveFilters();

            document.getElementById('filteredCount').textContent = filteredRecords.length;
            document.getElementById('totalCount').textContent = allRecords.length;
        }

        // ===== RENDERIZAR KANBAN =====
        function renderKanban(records) {
            Object.values(statusMap).forEach(colId => {
                document.getElementById(colId).innerHTML = '';
            });

            Object.values(countMap).forEach(countId => {
                document.getElementById(countId).textContent = '0';
            });

            const counts = {
                'Cota칞칚o': 0,
                'Ordem de Compra Emitida': 0,
                'Em Tr칙nsito': 0,
                'Recebido': 0,
                'Cancelado': 0
            };

            records.forEach(record => {
                const f = record.fields;
                const status = f['Select'] || 'Cota칞칚o';
                const colId = statusMap[status];

                if (colId) {
                    counts[status]++;
                    const card = createCard(f, record.id);
                    document.getElementById(colId).insertAdjacentHTML('beforeend', card);
                }
            });

            Object.keys(counts).forEach(key => {
                if (countMap[key]) {
                    document.getElementById(countMap[key]).textContent = counts[key];
                }
            });
        }

        // ===== CRIAR CARD =====
        function createCard(fields, recordId) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 card-hover transition-all duration-200 cursor-pointer">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">OC-${fields['N칰mero OC'] || 'N/A'}</span>
                        <span class="text-xs text-gray-400"><i class="far fa-calendar-alt mr-1"></i>${formatDate(fields['Data de Cria칞칚o'] || '')}</span>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 text-sm mb-1 line-clamp-2">${fields['Item'] || 'Sem t칤tulo'}</h3>
                    <p class="text-xs text-gray-500 mb-3 flex items-center">
                        <i class="fas fa-store mr-1"></i> ${fields['Fornecedor'] || 'Fornecedor n/a'}
                    </p>
                    
                    <div class="border-t border-gray-100 pt-3 flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            Qtd: <span class="font-medium text-gray-700">${fields['Quantidade'] || 0}</span>
                        </div>
                        <div class="text-sm font-bold text-green-600">
                            ${formatCurrency(fields['Valor Total'])}
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== ATUALIZAR FILTROS ATIVOS =====
        function updateActiveFilters() {
            const filters = [];
            const search = document.getElementById('searchInput').value;
            const fornecedor = document.getElementById('fornecedorFilter').value;
            const status = document.getElementById('statusFilter').value;
            const data = document.getElementById('dataFilter').value;

            if (search) filters.push(`Busca: "${search}"`);
            if (fornecedor) filters.push(`Fornecedor: ${fornecedor}`);
            if (status) filters.push(`Status: ${status}`);
            if (data) filters.push(`Per칤odo: 칔ltimos ${data} dias`);

            const container = document.getElementById('activeFilters');
            if (filters.length > 0) {
                container.innerHTML = '<div><strong>Filtros ativos:</strong> ' + filters.join(' | ') + '</div>';
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // ===== LIMPAR FILTROS =====
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('fornecedorFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dataFilter').value = '';
            applyFilters();
        }

        // ===== EXPORT EXCEL PROFISSIONAL =====
        function exportToXLSX() {
            if (filteredRecords.length === 0) {
                alert('Nenhum registro para exportar');
                return;
            }

            // Criar tabela HTML
            const table = document.getElementById('exportTable');
            table.innerHTML = '';

            // Cabe칞alho
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.style.backgroundColor = '#2563eb';
            headerRow.style.color = 'white';
            headerRow.style.fontWeight = 'bold';

            const headers = ['N췈 OC', 'Item', 'Fornecedor', 'Status', 'Quantidade', 'Valor Total', 'Data Cria칞칚o', 'Data Entrega'];
            headers.forEach(header => {
                const cell = headerRow.insertCell();
                cell.textContent = header;
                cell.style.padding = '10px';
                cell.style.border = '1px solid #000';
            });

            // Dados
            const tbody = table.createTBody();
            filteredRecords.forEach((record, index) => {
                const f = record.fields;
                const row = tbody.insertRow();
                row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f3f4f6';

                const cells = [
                    f['N칰mero OC'] || '',
                    f['Item'] || '',
                    f['Fornecedor'] || '',
                    f['Select'] || '',
                    f['Quantidade'] || 0,
                    `R$ ${(f['Valor Total'] || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    formatDate(f['Data de Cria칞칚o'] || ''),
                    formatDate(f['Data de Entrega Esperada'] || '')
                ];

                cells.forEach((cellText, idx) => {
                    const cell = row.insertCell();
                    cell.textContent = cellText;
                    cell.style.padding = '8px';
                    cell.style.border = '1px solid #ddd';
                    if (idx >= 4) cell.style.textAlign = 'right';
                });
            });

            // Exportar com SheetJS
            const ws = XLSX.utils.table_to_sheet(table);
            
            // Ajustar largura das colunas
            ws['!cols'] = [
                { wch: 10 },  // N췈 OC
                { wch: 35 },  // Item
                { wch: 20 },  // Fornecedor
                { wch: 18 },  // Status
                { wch: 12 },  // Quantidade
                { wch: 15 },  // Valor Total
                { wch: 15 },  // Data Cria칞칚o
                { wch: 15 }   // Data Entrega
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Compras');
            
            const fileName = `kanban-compras-${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ===== LOGIN SYSTEM =====
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('emailInput').value.trim();
            const loginError = document.getElementById('loginError');

            if (!email) {
                loginError.textContent = 'Por favor, insira um email v치lido';
                loginError.classList.remove('hidden');
                return;
            }

            // Valida칞칚o b치sica de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                loginError.textContent = 'Email inv치lido. Tente novamente.';
                loginError.classList.remove('hidden');
                return;
            }

            // Salvar sess칚o no localStorage
            currentUser = email;
            localStorage.setItem('kanban_user', email);
            loginError.classList.add('hidden');

            // Mostrar app, esconder login
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('userEmail').textContent = email;

            // Carregar dados
            fetchData();
        }

        function handleLogout() {
            if (confirm('Deseja sair da aplica칞칚o?')) {
                currentUser = null;
                localStorage.removeItem('kanban_user');
                
                // Voltar ao login
                document.getElementById('appContent').classList.add('hidden');
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('emailInput').value = '';
                
                // Limpar dados
                allRecords = [];
                filteredRecords = [];
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('kanban_user');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('userEmail').textContent = savedUser;
                fetchData();
            }
        }

        // ===== INICIAR =====
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
